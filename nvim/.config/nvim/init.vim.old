syntax on

filetype plugin on

set autoindent
set ignorecase
set smartcase
set number
set autochdir
set smartindent
set tabstop=4
set shiftwidth=4
set listchars=""
set clipboard=unnamedplus
set noshowmatch
set relativenumber
set noerrorbells
set incsearch
set nobackup
set undofile
set nohlsearch
set termguicolors
set mouse=a
set updatetime=300 " Trigger CursorHold after 300 ms
set textwidth=100
set colorcolumn=100

set completeopt=menuone,noinsert,noselect

" Avoid showing extra messages when using completion
set shortmess+=c
" For scala metals
set shortmess-=F

" Cursor shapes in different modes
let &t_SI = "\<Esc>[6 q"
let &t_SR = "\<Esc>[4 q"
let &t_EI = "\<Esc>[2 q"


" Plug
" ==================================================

call plug#begin('~/.vim/plugged')

Plug 'neovim/nvim-lspconfig'

Plug 'hrsh7th/nvim-cmp'
Plug 'hrsh7th/cmp-nvim-lsp'
Plug 'hrsh7th/cmp-vsnip'
Plug 'hrsh7th/cmp-path'
Plug 'hrsh7th/cmp-buffer'
Plug 'hrsh7th/vim-vsnip'
Plug 'uga-rosa/cmp-dictionary'

Plug 'simrat39/rust-tools.nvim'
Plug 'scalameta/nvim-metals'

Plug 'nvim-lua/plenary.nvim'

Plug 'lervag/vimtex'
Plug 'vim-pandoc/vim-pandoc'
Plug 'dhruvasagar/vim-table-mode'
Plug 'chrisbra/csv.vim'
Plug 'sedm0784/vim-you-autocorrect'

Plug 'mbbill/undotree'
Plug 'sheerun/vim-polyglot'
Plug 'vim-airline/vim-airline'
Plug 'gruvbox-community/gruvbox'
Plug 'nathanaelkane/vim-indent-guides'
Plug 'chrisbra/SudoEdit.vim'
Plug 'bronson/vim-trailing-whitespace'

Plug 'tpope/vim-fugitive'

Plug 'ahmedkhalf/project.nvim'
Plug 'junegunn/fzf', { 'do': { -> fzf#install() } }
Plug 'junegunn/fzf.vim'

" File explorer
Plug 'kyazdani42/nvim-web-devicons'
Plug 'kyazdani42/nvim-tree.lua'

let g:airline_powerline_fonts = 1

let g:indent_guides_guide_size = 1

let g:pandoc#command#autoexec_on_writes = 1
let g:pandoc#command#autoexec_command = "Pandoc pdf"
let g:pandoc#command#latex_engine = "pdflatex"

let g:vimtex_view_method = 'zathura'
let g:vimtex_quickfix_open_on_warning = 0

if !exists('g:airline_symbols')
	let g:airline_symbols = {}
endif
let g:airline_symbols.linenr='ï¡›'

let g:fzf_layout = { 'down': '~20%' }

call plug#end()


" Colorscheme
" ==================================================

colorscheme gruvbox
set background=dark
set t_ut= "disable the Background Color Erase that messes with some color schemes


" Custom remaps
" ==================================================

let mapleader=" "

map + <C-w>+
map - <C-w>-
map <leader>+ <C-w>>
map <leader>- <C-w><

map <leader>h :wincmd h<CR>
map <leader>j :wincmd j<CR>
map <leader>k :wincmd k<CR>
map <leader>l :wincmd l<CR>

map <leader>s :sp<CR>
map <leader>v :vsp<CR>

nmap tl :tabnext<CR>
nmap th :tabprevious<CR>
nmap <leader>t :tabnew<CR>

nmap <leader>u :UndotreeToggle<CR>

map <F6> :setlocal spell! spelllang=en_us <CR>
map <Enter> o<ESC>

nmap zU <Plug>VimyouautocorrectUndo

" Compile and run C++
map <F8> :w <CR> :!clear && g++ % -o '%:r' && ./'%:r' <CR>

" Shift-S for terminal in new tab
nmap <S-s> :tabnew \| term<CR>

" Ctrl-S for terminal in new tab
nmap <C-s> :bel split \| wincmd j \| resize 8 \| term<CR>

" Esc to exit terminal mode
tnoremap <Esc> <C-\><C-n>

" Goto previous/next diagnostic warning/error
nnoremap <silent> g[    <cmd>lua vim.diagnostic.goto_prev()<CR>
nnoremap <silent> g]    <cmd>lua vim.diagnostic.goto_next()<CR>

"user Code action
nnoremap <silent> ga    <cmd>lua vim.lsp.buf.code_action()<CR>

nnoremap <silent> gd    <cmd>lua vim.lsp.buf.definition()<CR>
nnoremap <silent> K     <cmd>lua vim.lsp.buf.hover()<CR>

nnoremap <leader>e 	:NvimTreeToggle<CR>

nnoremap <leader>gg 	:Git<space>
nnoremap <leader>gs 	:Git<CR>
nnoremap <leader>gc 	:Git commit<CR>
nnoremap <leader>gd 	:G diff<CR>
nnoremap <leader>ga 	:G add<space>
nnoremap <leader>gp 	:G push<space>
nnoremap <leader>gP 	:G pull<space>

" Autocmd
" ==================================================

augroup configFiles
	autocmd!
	autocmd BufWritePost $XDG_CONFIG_HOME/polybar/config call system('$XDG_CONFIG_HOME/polybar/launch.sh')
	autocmd BufWritePost $XDG_CONFIG_HOME/i3/config call system('i3 restart')
augroup end

" Show diagnostic popup on cursor hover
autocmd CursorHold * lua vim.diagnostic.open_float(nil, { focusable = false })

autocmd BufWritePre <buffer> lua vim.lsp.buf.formatting_sync()

augroup vimtex_config
        autocmd!
        autocmd User VimtexEventQuit call vimtex#compiler#clean(0)
augroup END

if has('nvim-0.5')
  augroup lsp
    au!
    au FileType scala,sbt lua require('metals').initialize_or_attach(metals_config)
  augroup end
endif

" close term if the program run without error
autocmd TermClose * if !v:event.status | exe 'bdelete! '..expand('<abuf>') | endif

" start terminal in insert mode
autocmd TermOpen * startinsert


" LSP
" ==================================================

" Configure LSP through rust-tools.nvim plugin.
" rust-tools will configure and enable certain LSP features for us.
" See https://github.com/simrat39/rust-tools.nvim#configuration
lua <<EOF
local nvim_lsp = require'lspconfig'

local opts = {
    tools = { -- rust-tools options
        autoSetHints = true,
        hover_with_actions = true,
    },

    -- all the opts to send to nvim-lspconfig
    -- these override the defaults set by rust-tools.nvim
    -- see https://github.com/neovim/nvim-lspconfig/blob/master/doc/server_configurations.md#rust_analyzer
    server = {
        -- on_attach is a callback called when the language server attachs to the buffer
        -- on_attach = on_attach,
        settings = {
            -- to enable rust-analyzer settings visit:
            -- https://github.com/rust-analyzer/rust-analyzer/blob/master/docs/user/generated_config.adoc
            ["rust-analyzer"] = {
                -- enable clippy on save
                checkOnSave = {
                    command = "clippy"
                },
            }
        }
    },
}

require('rust-tools').setup(opts)
EOF

:lua require'lspconfig'.texlab.setup{}

" Setup Completion
" See https://github.com/hrsh7th/nvim-cmp#basic-configuration
lua <<EOF
local cmp = require'cmp'
cmp.setup({
  preselect = cmp.PreselectMode.None,
  -- Enable LSP snippets
  snippet = {
    expand = function(args)
        vim.fn["vsnip#anonymous"](args.body)
    end,
  },
  mapping = {
    ['<C-p>'] = cmp.mapping.select_prev_item(),
    ['<C-n>'] = cmp.mapping.select_next_item(),
    -- Add tab support
    ['<S-Tab>'] = cmp.mapping.select_prev_item(),
    ['<Tab>'] = cmp.mapping.select_next_item(),
    ['<C-j>'] = cmp.mapping.scroll_docs(-4),
    ['<C-k>'] = cmp.mapping.scroll_docs(4),
    ['<C-Space>'] = cmp.mapping.complete(),
    ['<C-e>'] = cmp.mapping.close(),
    ['<CR>'] = cmp.mapping.confirm({
      behavior = cmp.ConfirmBehavior.Insert,
      select = true,
    })
  },

  -- Installed sources
  sources = {
    { name = 'nvim_lsp' },
    { name = 'vsnip' },
    { name = 'path' },
    { name = 'buffer' },
    { name = 'dictionary', keyword_length = 2 },
  },
})
EOF

" Dictionary autocomplete
lua <<EOF
require'cmp_dictionary'.setup({
		dic = {
			spelllang = {
				en = "./spell/de.utf-8.add.spl",
			},
		},
		-- The following are default values.
		exact = 2,
		first_case_insensitive = false,
		document = false,
		document_command = "wn %s -over",
		async = false,
		capacity = 5,
		debug = false,
})
EOF

lua <<EOF
metals_config = require("metals").bare_config()

metals_config.settings = {
  	showImplicitArguments = true,
  	excludedPackages = { "akka.actor.typed.javadsl", "com.github.swagger.akka.javadsl" },
	serverVersion = "latest.snapshot"
}

metals_config.root_patterns = {'.project_nvim'}

local capabilities = vim.lsp.protocol.make_client_capabilities()
metals_config.capabilities = require("cmp_nvim_lsp").update_capabilities(capabilities)
EOF

" nvim-tree
" ==================================================
lua <<EOF
require"nvim-tree".setup{
	view = {
		preserve_window_proportions = true,
		width = 25,
		adaptive_size = true,
		mappings = {
			custom_only = true,
			list = {
				{ key = "g?",                            	action = "" },
				{ key = "?",                             	action = "toggle_help" },
				{ key = ".",								action = "toggle_dotfiles" },
				{ key = { "<CR>", "o", "<2-LeftMouse>" }, 	action = "edit" },
				{ key = "q",                              	action = "close" },
				{ key = "n",                              	action = "create" },
    			{ key = "dD",                              	action = "remove" },
    			{ key = "dT",                              	action = "trash" },
    			{ key = "a",                              	action = "rename" },
				{ key = "dd",                              	action = "cut" },
    			{ key = "yy",                              	action = "copy" },
    			{ key = "yn",                              	action = "copy_name" },
    			{ key = "yp",                              	action = "copy_path" },
    			{ key = "p",                              	action = "paste" },
    			{ key = "t",                              	action = "tabnew" },
    			{ key = "s",                              	action = "split" },
    			{ key = "v",                              	action = "vsplit" },
			}
		}
	},
	trash = {
    	cmd = "trash-put",
    	require_confirm = true,
  	},
	filters = {
		dotfiles = true,
	},
	actions = {
		open_file = {
			quit_on_open = true,
		}
	},
}
EOF

" nvim-tree
" ==================================================
lua <<EOF
require("project_nvim").setup {
	patterns = {".project_nvim", ".git", "_darcs", ".hg", ".bzr", ".svn", "Makefile", "package.json" },
}
EOF
